name: Share data between jobs

on:
  push:
    branches:
      - suman-deploy

jobs:
  job_1:
    name: Add 3 and 7
    runs-on: windows-latest
    steps:
      - shell: bash
        run: |
          expr 3 + 7 > math-homework.txt
      - name: Upload math result for job 1
        uses: actions/upload-artifact@v3
        with:
          name: homework
          path: math-homework.txt

  job_2:
    name: Multiply by 9
    needs: job_1
    runs-on: windows-latest
    steps:
      - name: Download math result for job 1
        uses: actions/download-artifact@v3
        with:
          name: homework
      - shell: bash
        run: |
          value=`cat math-homework.txt`
          expr $value \* 9 > math-homework.txt
      - name: Upload math result for job 2
        uses: actions/upload-artifact@v3
        with:
          name: homework
          path: math-homework.txt

  job_3:
    name: Display results
    needs: job_2
    runs-on: windows-latest
    steps:
      - name: Download math result for job 2
        uses: actions/download-artifact@v3
        with:
          name: homework
      - name: Print the final result
        shell: bash
        run: |
          value=`cat math-homework.txt`
          echo The result is $value
      - name: Install WinRM
        run: |
          if(!(Test-Path C:\Windows\System32\WindowsPowerShell\v1.0\Modules\PSRemoting)) {
          Enable-PSRemoting -Force
          }
          Get-Service -Name WinRM
          Enable-PSRemoting -Force
          Set-ItemProperty -Path HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System -Name LocalAccountTokenFilterPolicy -Value 1
          Restart-Service -Name WinRM


      - name: Deploy artifacts
        env:
          WINRM_HOST: "16.170.210.149"
          WINRM_USER: "Administrator"
          WINRM_PASSWORD: "72sy!LuHfoRsVS=xhsl$.OWvBbEZTfrA"
          WINRM_DESTINATION: 'C:\'
        run: |
          #Test-Connection -ComputerName "16.170.210.149"
          #Test-NetConnection -ComputerName "16.170.210.149" -Port 5985
          
          # Create WinRM session
          winrm s winrm/config/client '@{TrustedHosts="16.170.210.149"}'

          $securePassword = ConvertTo-SecureString $env:WINRM_PASSWORD -AsPlainText -Force
          $credential = New-Object System.Management.Automation.PSCredential ($env:WINRM_USER, $securePassword)
          $session = New-PSSession -ComputerName $env:WINRM_HOST -Credential $credential

          # Copy artifacts to destination
          Copy-Item -Path $env:GITHUB_WORKSPACE\dist\* -Destination $env:WINRM_DESTINATION -ToSession $session
